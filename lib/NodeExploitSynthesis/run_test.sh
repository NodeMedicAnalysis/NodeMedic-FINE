#!/bin/bash

# Call this script with a directory containing a taint.json file
# Ex: ./run.sh tests/provenance_graph/test1

set -e

if [ -z "$1" ]; then
    echo "Missing path to a directory with taint.json";
    exit 1;
fi

if [[ -d "$1" ]]; then
    echo "$1 is a valid directory; continuing...";
else
    echo "Argument 1: '$1' is not a directory";
    exit 1;
fi

TYPE="error"

if [ -e "$1/taint.json" ]; then
    echo "Driver file exists; continuing...";
    TYPE=""
else
    echo "taint.json does not exist in $1";
fi

if [ -e "$1/taint_0.json" ]; then
    echo "Driver file exists; continuing...";
    TYPE="_0"
else
    echo "taint.json does not exist in $1";
fi

if [ "$TYPE" = "error" ]; then
    echo "taint*.json does not exist in $1";
    exit 1;
fi

echo "Cleaning analysis output"
rm synthesis.out || echo "No synthesis.out";
echo "Done"

echo "Analyzing $1"
(python3 -m src.main --allow-unsound --prov=$1/taint${TYPE}.json ${@:2} &> synthesis.out) || true;
echo "Done"

echo "Moving synthesis results"
sleep 1;
mv synthesis.out $1
echo "Done"
